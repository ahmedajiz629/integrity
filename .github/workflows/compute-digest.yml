name: Compute Integrity Digest

on:
  workflow_dispatch:
  push:
    paths:
      - test/index.html
      - .github/workflows/compute-digest.yml

jobs:
  digest:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Compute sha256 digest for test/index.html
        id: digest
        shell: bash
        run: |
          DIGEST=$(node <<'NODE'
          const fs = require('fs');
          const crypto = require('crypto');
          const data = fs.readFileSync('test/index.html');
          process.stdout.write(`length=${data.length}\n`);
          const bytes1 = Array.from(data.slice(0, 300)).map((b) => b.toString(16).padStart(2, '0')).join(' ');
          const bytes2 = Array.from(data.slice(300, 600)).map((b) => b.toString(16).padStart(2, '0')).join(' ');
          const bytes3 = Array.from(data.slice(600)).map((b) => b.toString(16).padStart(2, '0')).join(' ');
          process.stdout.write(`bytes=${bytes1} ${bytes2} ${bytes3}\n`);
          const hash = crypto.createHash('sha256').update(data).digest('base64');
          const base64url = hash.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
          process.stdout.write(base64url);
          NODE
          )
          echo "sha256-$DIGEST"
          echo "sha256-$DIGEST" >> "$GITHUB_STEP_SUMMARY"
